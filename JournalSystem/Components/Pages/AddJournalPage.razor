@page "/add-journal"

@inject IJSRuntime JS
@inject IJournalService JournalService
@inject NavigationManager Nav


<EditForm Model="formModel" OnValidSubmit="HandleSubmit">
    <DataAnnotationsValidator />

    <div>
        <label class="text-sm font-semibold text-slate-700">Date</label>
        <div class="text-sm text-slate-500">@formModel.EntryDate.ToString("yyyy/MM/dd")</div>
    </div>

    <div>
        <label class="text-sm font-semibold text-slate-700">Title</label>
        <InputText
            class="mt-1 w-full rounded-lg border border-slate-200 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary"
            @bind-Value="formModel.Title" />
    </div>

    <div>
        <label class="text-sm font-semibold text-slate-700">Primary Mood</label>
        <select
            class="mt-1 w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary"
            @bind="formModel.PrimaryMood">
            @foreach (var mood in MoodCatalog.All)
            {
                <option value="@mood">@mood</option>
            }
        </select>
    </div>

    <div>
        <label class="text-sm font-semibold text-slate-700">Content</label>
        <div id="editor" class="mt-2 rounded-lg border border-slate-200" style="height: 16rem;"></div>
    </div>

    <div>
        <label class="text-sm font-semibold text-slate-700">Tags</label>
        <div class="mt-2 flex flex-wrap items-center gap-2">
            <select
                class="w-full max-w-[14rem] rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary"
                @bind="selectedTag">
                <option value="">select</option>
                @foreach (var tag in TagCatalog.PredefinedTags)
                {
                    <option value="@tag">@tag</option>
                }
            </select>
            <button type="button" class="border-0 bg-transparent p-0" @onclick="HandleAddTag">
                <AppButton Variant="outline" ClassName="h-9">Add</AppButton>
            </button>
        </div>

        <div class="mt-3 flex flex-wrap gap-2">
            @foreach (var tag in formModel.Tags)
            {
                <span class="cursor-pointer rounded-full bg-primary/10 px-3 py-1 text-xs font-semibold text-primary"
                    @onclick="@(() => HandleRemoveTag(tag))">
                    @tag
                </span>
            }
        </div>
    </div>

    <div class="flex flex-wrap gap-3">
        <button type="submit" class="border-0 bg-transparent p-0">
            <AppButton ClassName="min-w-[8rem]">Save</AppButton>
        </button>
        <button type="button" class="border-0 bg-transparent p-0" @onclick='() => Nav.NavigateTo("/journals")'>
            <AppButton Variant="outline" ClassName="min-w-[8rem]">Cancel</AppButton>
        </button>
    </div>
</EditForm>

@code {
    JournalEntry formModel = new()
    {
        EntryDate = DateTime.Today,
        PrimaryMood = Mood.Calm
    };

    string? selectedTag;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await JS.InvokeVoidAsync("initQuill", "editor");
        }
    }

    async Task HandleSubmit()
    {
        formModel.Content = await JS.InvokeAsync<string>("getQuillHtml");
        await JournalService.SaveItemAsync(formModel);
        Nav.NavigateTo("/journals");
    }

    void HandleAddTag()
    {
        if (string.IsNullOrWhiteSpace(selectedTag)) return;
        var tag = TagCatalog.NormalizeTag(selectedTag);
        if (string.IsNullOrWhiteSpace(tag)) return;

        if (!formModel.Tags.Any(t => string.Equals(t, tag, StringComparison.OrdinalIgnoreCase)))
        {
            formModel.Tags.Add(tag);
        }

        selectedTag = string.Empty;
    }

    void HandleRemoveTag(string tag)
    {
        formModel.Tags.Remove(tag);
    }
}