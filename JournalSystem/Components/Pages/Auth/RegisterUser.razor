@using JournalSystem.Components.Layout
@inject IPasswordService PasswordService
@inject IPreferenceService PreferenceService

@inject NavigationManager Nav

@layout AuthLayout

@page "/register"


<MudContainer Class="d-flex align-center justify-center" Style="min-height:100vh;">
    <MudPaper Class="pa-6 rounded-xl shadow-sm" Style="width:100%; max-width:420px;">

        <EditForm Model="formModel" OnValidSubmit="Register">

            <h3>Create PIN</h3>


            <InputText type="Username"
                       placeholder="Confirm PIN"
                       @bind-Value="formModel.Username"
                       style="width:100%; padding:8px; margin-top:12px; border:1px solid #000;" />

            <InputText type="password"
                       placeholder="PIN"
                       @bind-Value="formModel.Pin"
                       style="width:100%; padding:8px; margin-top:12px; border:1px solid #000;" />

            <InputText type="password"
                       placeholder="Confirm PIN"
                       @bind-Value="formModel.ConfirmPin"
                       style="width:100%; padding:8px; margin-top:12px; border:1px solid #000;" />
           

            @if (Error != string.Empty)
            {
                <div class="error-message">@Error</div>
            }


            <MudButton Class="mt-4"
                       Variant="Variant.Filled"
                       Color="Color.Primary"
                       ButtonType="ButtonType.Submit"
                       FullWidth="true">
                Register
            </MudButton>

        </EditForm>

    </MudPaper>
</MudContainer>

@code {

    public string Error { get; set; } = string.Empty;

    public class LoginFormModel
    {
        public string Pin { get; set; } = string.Empty;
        public string ConfirmPin { get; set; } = string.Empty;
        public string Username { get; set; } = string.Empty;
    }

    LoginFormModel formModel = new();

    async Task Register()
    {
        if (formModel.Pin != formModel.ConfirmPin)
        {
            Error = "PINs do not match.";
            return;
        }

        try
        {
            PreferenceService.SetUsername(formModel.Username);
            await PasswordService.SetKey(formModel.Pin);
            Nav.NavigateTo("/login", true);
        }
        catch (Exception e)
        {   
            Error = e.Message;
        }

    }
}
