@using JournalSystem.Components.Globals
@using JournalSystem.Components.Layout
@using Microsoft.AspNetCore.Components.Forms
@using System.ComponentModel.DataAnnotations
@using JournalSystem.Services.Interface

@layout AuthLayout
@page "/register"

@inject IUserService UserService
@inject NavigationManager Nav

<div class="min-h-screen flex items-center justify-center px-4">
    <div class="w-full max-w-md rounded-2xl border border-slate-200 bg-white p-8 shadow-sm">
        <EditForm Model="formModel" OnValidSubmit="Register" class="space-y-6">
            <DataAnnotationsValidator />

            <div class="space-y-2">
                <h2 class="text-xl font-medium text-slate-900">
                    Create Account
                </h2>
                <p class="text-sm text-slate-600">
                    Set a username and PIN to continue
                </p>
            </div>

            <div class="space-y-3">
                <InputText placeholder="Username" @bind-Value="formModel.Username"
                    class="w-full rounded-lg border border-slate-300 px-4 py-3 text-slate-900 placeholder-slate-400 focus:border-primary focus:outline-none focus:ring-2 focus:ring-primary/20 transition-shadow" />

                <InputText type="password" placeholder="PIN" @bind-Value="formModel.Pin"
                    class="w-full rounded-lg border border-slate-300 px-4 py-3 text-slate-900 placeholder-slate-400 focus:border-primary focus:outline-none focus:ring-2 focus:ring-primary/20 transition-shadow" />

                <InputText type="password" placeholder="Confirm PIN" @bind-Value="formModel.ConfirmPin"
                    class="w-full rounded-lg border border-slate-300 px-4 py-3 text-slate-900 placeholder-slate-400 focus:border-primary focus:outline-none focus:ring-2 focus:ring-primary/20 transition-shadow" />

                @if (!string.IsNullOrEmpty(Error))
                {
                    <p class="text-sm text-red-600">@Error</p>
                }
            </div>

            <button type="submit" class="w-fit">
                <AppButton ClassName="w-full">
                    Register
                    <i class="fi fi-rr-user-add"></i>
                </AppButton>
            </button>
        </EditForm>
    </div>
</div>

@code {
    public class RegisterFormModel
    {
        [Required]
        public string Username { get; set; } = string.Empty;

        [Required]
        public string Pin { get; set; } = string.Empty;

        [Required]
        public string ConfirmPin { get; set; } = string.Empty;
    }

    RegisterFormModel formModel = new();
    public string Error { get; set; } = string.Empty;

    async Task Register()
    {
        Error = string.Empty;

        if (formModel.Pin != formModel.ConfirmPin)
        {
            Error = "PINs do not match.";
            return;
        }

        try
        {
            await UserService.CreateUser(formModel.Username, formModel.Pin);
            Nav.NavigateTo(SiteRoutes.Login, true);
        }
        catch (Exception e)
        {
            Error = e.Message;
        }
    }
}