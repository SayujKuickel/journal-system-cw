@page "/add-journal"
@page "/add-journal/{Id}"
@using System.ComponentModel.DataAnnotations
@using ABI.Windows.AI.MachineLearning

@inject NavigationManager Nav

@inject IJournalService JournalService
@inject IMoodService MoodService
@inject ITagService TagService
@inject ICategoryService CategoryService
@inject ToastService ToastService


<header class="space-y-2">
    <h1 class="text-4xl font-bold">
        @if (Guid.TryParse(Id, out var guid))
        {
            <span>Editing Journal Entry</span>
        }
        else
        {
            <span>Creating new Journal </span>
        }
    </h1>
    <div class="text-sm text-muted-foreground">@formModel.EntryDate.ToString("yyyy/MM/dd")</div>
</header>

<EditForm Model="formModel" OnValidSubmit="HandleSubmit" class="space-y-3 grid grid-cols-3 gap-4">
    <DataAnnotationsValidator />

    <section class="col-span-2 space-y-6">
        <div>
            <label class="text-sm font-semibold text-muted-foreground">Title*</label>
            <InputText
                class="mt-1 w-full rounded-lg border border-border px-3 py-2 text-sm text-foreground focus:outline-none focus:ring-2 focus:ring-primary"
                @bind-Value="formModel.Title" />
            <ValidationMessage class="text-sm text-destructive" For="@(() => formModel.Title)" />
        </div>

        @if (readyToRender)
        {
            <div>
                <label class="text-sm font-semibold text-muted-foreground">Content*</label>
                <QuillEditor @ref="editor" EditorId="@editorId" Value="@pendingRichText" />

                @if (showRichTextError)
                {
                    <div class="text-sm text-destructive">Content is required.</div>
                }
            </div>
        }
    </section>

    <aside class="flex flex-col justify-between">
        <div class="space-y-2">
            <section class="flex-1">
                <label class="text-sm font-semibold text-muted-foreground">Category*</label>
                <InputSelect @bind-Value="formModel.Category"
                    class="mt-1 w-full rounded-lg border border-border px-3 py-2 text-sm text-foreground focus:outline-none focus:ring-2 focus:ring-primary">
                    <option value="0">Choose</option>
                    @foreach (var item in categories)
                    {
                        <option value="@item.Id">@item.Name</option>
                    }
                </InputSelect>
                <ValidationMessage class="text-sm text-destructive" For="@(() => formModel.Category)" />
            </section>

            <section>
                <div class="flex items-end gap-2">
                    <div class="flex-1">
                        <label class="text-sm font-semibold text-muted-foreground">Mood*</label>
                        <select @bind="currentMood"
                            class="mt-1 w-full rounded-lg border border-border px-3 py-2 text-sm text-foreground focus:outline-none focus:ring-2 focus:ring-primary">
                            <option value="0">Choose</option>
                            @foreach (var mood in moods)
                            {
                                if (!formModel.ChosenMoods.Contains(mood.Id))
                                {
                                    <option value="@mood.Id">@mood.Name</option>
                                }
                            }
                        </select>
                    </div>

                    @if (formModel.ChosenMoods.Count < 3)
                    {
                        <button type="button" @onclick="AddMood">
                            <AppButton Variant="outline" ClassName="block py-3">
                                <i class="fi fi-rr-plus scale-75"></i>
                            </AppButton>
                        </button>
                    }
                </div>

                <p class="flex gap-1 flex-wrap mt-3">
                    @foreach (var item in formModel.ChosenMoods.Select((id, index) => new { id, index }))
                    {
                        var mood = moods.FirstOrDefault(el => el.Id == item.id);
                        if (mood != null)
                        {
                            <span
                                class="px-2 bg-primary/20 border border-primary rounded-lg text-nowrap hover:bg-destructive hover:text-foreground cursor-pointer transition-all flex items-center gap-0.5"
                                @onclick="() => RemoveMood(mood.Id)">
                                @if (item.index == 0)
                                {
                                    <i class="fi fi-rr-crown text-primary"></i>
                                }
                                @mood.Name
                            </span>
                        }
                    }
                </p>
                <ValidationMessage class="text-sm text-destructive" For="@(() => formModel.ChosenMoods)" />
            </section>

            <section>
                <div class="flex items-end gap-2">
                    <div class="flex-1">
                        <label class="text-sm font-semibold text-muted-foreground">Tags</label>
                        <select @bind="currentTag"
                            class="mt-1 w-full rounded-lg border border-border px-3 py-2 text-sm text-foreground focus:outline-none focus:ring-2 focus:ring-primary">
                            <option value="0">Choose</option>
                            @foreach (var tag in tags)
                            {
                                if (!formModel.ChosenTags.Contains(tag.Id))
                                {
                                    <option value="@tag.Id">@tag.Name</option>
                                }
                            }
                        </select>
                    </div>

                    <button type="button" @onclick="AddTag">
                        <AppButton Variant="outline" ClassName="block py-3">
                            <i class="fi fi-rr-plus scale-75"></i>
                        </AppButton>
                    </button>
                </div>

                <p class="flex gap-x-2 gap-y-1.5 flex-wrap mt-3">
                    @foreach (var tagId in formModel.ChosenTags)
                    {
                        var tag = tags.FirstOrDefault(el => el.Id == tagId);
                        if (tag != null)
                        {
                            <span
                                class="px-2 bg-primary/5 outline-2 outline-primary rounded-lg text-nowrap hover:bg-destructive hover:text-foreground cursor-pointer transition-all"
                                @onclick="() => RemoveTag(tagId)">
                                @tag.Name
                            </span>
                        }
                    }
                </p>
                <ValidationMessage class="text-sm text-destructive" For="@(() => formModel.ChosenTags)" />
            </section>
        </div>

        <div class="flex flex-wrap justify-end gap-3">
            <button type="button" @onclick='() => Nav.NavigateTo(SiteRoutes.Journal)'>
                <AppButton Variant="outline" ClassName="min-w-[8rem]">Cancel</AppButton>
            </button>

            <button type="submit">
                <AppButton ClassName="min-w-[8rem]">Save</AppButton>
            </button>
        </div>
    </aside>
</EditForm>


@* Mood handler *@
@code {
    int currentMood = 0;

    void AddMood()
    {
        if (currentMood != 0 && !formModel.ChosenMoods.Contains(currentMood) && formModel.ChosenMoods.Count < 3)
        {
            formModel.ChosenMoods.Add(currentMood);
            currentMood = 0;
        }
    }

    void RemoveMood(int id)
    {
        formModel.ChosenMoods.Remove(id);
    }
}

@* Tag handler *@
@code {
    int currentTag = 0;

    void AddTag()
    {
        if (currentTag != 0 && !formModel.ChosenTags.Contains(currentTag))
        {
            formModel.ChosenTags.Add(currentTag);
            currentTag = 0;
        }
    }

    void RemoveTag(int id)
    {
        formModel.ChosenTags.Remove(id);
    }
}

@* Form handler *@
@code {
    JournalFormModel formModel = new()
    {
        EntryDate = DateTime.Today,
    };

    QuillEditor? editor;
    bool showRichTextError = false;
    string editorId = string.Empty;


    async Task HandleSubmit()
    {
        var richText = await editor!.GetHtml() ?? string.Empty;

        var plain = System.Text.RegularExpressions.Regex.Replace(richText, "<.*?>", "").Trim();
        if (string.IsNullOrWhiteSpace(plain))
        {
            showRichTextError = true;
            return;
        }

        showRichTextError = false;

        if (Guid.TryParse(Id, out var guid))
        {
            await JournalService.UpdateJournalEntry(guid, formModel, richText);
            ToastService.Show("Journal Edited Successfully!", ToastType.Success);
        }
        else
        {
            await JournalService.SaveJournalEntry(formModel, richText);
            ToastService.Show("Journal created Successfully!", ToastType.Success);
        }

        Nav.NavigateTo(SiteRoutes.Journal);
    }
}

@* initialzier *@
@code {
    [Parameter] public string Id { get; set; } = string.Empty;

    @*  *@
    List<Mood> moods = [];
    List<Tag> tags = [];
    List<Category> categories = [];

    string? pendingRichText;
    bool readyToRender = false;

    protected override async Task OnInitializedAsync()
    {
        moods = await MoodService.GetItemsAsync();
        tags = await TagService.GetItemsAsync();
        categories = await CategoryService.GetItemsAsync();
    }

    protected override async Task OnParametersSetAsync()
    {
        readyToRender = false;

        formModel = new JournalFormModel
        {
            EntryDate = DateTime.Today
        };

        // edit mode
        if (Guid.TryParse(Id, out var guid))
        {
            var stored = await JournalService.GetItemAsync(guid);
            if (stored == null)
            {
                Nav.NavigateTo(SiteRoutes.Journal);
                return;
            }

            var storedMoods = await JournalService.GetSecondaryMoodsAsync(guid);
            var storedTags = await JournalService.GetTagsAsync(guid);

            formModel.Title = stored.Title;
            formModel.Category = stored.Category;
            formModel.ChosenMoods = [stored.PrimaryMood, .. storedMoods];
            formModel.ChosenTags = storedTags;
            pendingRichText = stored.RichText;

            editorId = $"journal-{guid}";
            readyToRender = true;
            return;
        }

        // create mode
        var existingEntry = await JournalService.GetItemByDateAsync(DateTime.Today);
        if (existingEntry != null)
        {
            ToastService.Show("Journal Entry already exists for today!", ToastType.Info);
            Nav.NavigateTo($"{SiteRoutes.ViewJournal}/{existingEntry.Id}");
            return;
        }

        editorId = $"journal-new-{DateTime.UtcNow.Ticks}";
        readyToRender = true;
    }
}